Okta.Auth=function(c,d,s,u,e){var l,t=Okta._okta,f=t.extend,o=t.clone,h=t.find,r=t.each,k=t.partial,i=Okta.fn.authUtil.getDefaultOAuthParams,g=Okta.fn.authUtil.toQueryParams,v=Okta.fn.authUtil.getOAuthUrls,m=Okta.fn.authUtil.convertOAuthParamsToQueryParams,p=Okta.fn.authUtil.validateResponse,E=Okta.fn.authUtil.validateOptions,_=Okta.fn.authUtil.validateClaims,w=Okta.fn.authUtil.validateClaimsTime,O=Okta.fn.authUtil.decodeToken,U=Okta.Q,n=Okta.Constants.AuthOptions.PKCE,a=n.DEFAULT_CODE_CHALLENGE_METHOD,y=n.MIN_VERIFIER_LENGTH,T=n.MAX_VERIFIER_LENGTH,C=Okta.LastError(d,e),I={};function A(e,t){t=o(t)||{};var r=i(e);return f(r,t),r.codeChallengeMethod||(r.codeChallengeMethod=a),r.responseType="code",function n(e){var t=e+"/.well-known/openid-configuration";return s.getOktaUnauthenticatedRequest(t)}(e.oktaDomain).then(function(e){if(-1===(e.code_challenge_methods_supported||[]).indexOf(r.codeChallengeMethod))throw new Error("Invalid code_challenge_method");l=e.jwks_uri}).then(function(){var e=function n(e){var t=e||"";return t.length<y&&(t+=u.generateRandomString(y-t.length)),encodeURIComponent(t).slice(0,T)}(r.codeVerifier),t={codeVerifier:e,redirectUri:r.redirectUri};return d.setPKCEMeta(t).then(function(){return u.computeChallenge(e)})}).then(function(e){return f({},r,{codeChallenge:e})})}function L(t,e,n){var r=U.defer();function o(e){if(e.data&&e.data.state===n)return e.origin!==t.url?r.reject(new Error("The request does not match client configuration")):void r.resolve(e.data)}return function i(e,t,n){e.addEventListener?e.addEventListener(t,n):e.attachEvent("on"+t,n)}(window,"message",o),r.promise.timeout(e||12e4,new Error("OAuth flow timed out")).fin(function(){!function r(e,t,n){e.removeEventListener?e.removeEventListener(t,n):e.detachEvent("on"+t,n)}(window,"message",o)})}function M(i,a){return U().then(function(){if(!i||!i.idToken)return U.reject("Only idTokens may be verified");var e=O(i.idToken),t={clientId:c.clientId,issuer:c.issuer||c.url,ignoreSignature:c.ignoreSignature};f(t,a);var n=w(e.payload);if(n)return C.set(n,"popover.errorPage.error.timeZoneOffset").then(k(U.reject,n));var r=_(e.payload,t);return r?U.reject(r):1==t.ignoreSignature?i:function o(e,n){if(!l)throw new Error("jwks_url is not in "+e+"./well-known/openid-configuration");return s.getOktaUnauthenticatedRequest(l).then(function(e){var t=h(e.keys,function(e){return e.kid==n});if(t)return t;throw new Error("The key id, "+n+", was not found in the server's keys")})}(i.issuer,e.header.kid).then(function(e){return u.verifyAuthIdToken(i.idToken,e,!0)}).then(function(e){return e&&e.valid?i:U.reject("The token signature is not valid")})})}function P(e,i,t,a){a=a||{};var n=i.responseType,u=o(i.scopes),c=i.clientId||e.clientId;return U().then(function(){if(p(t,i),t.code)return n=["access_token","id_token"],function e(n,r,o){return d.getPKCEMeta().then(function(e){var t={clientId:n.clientId,authorizationCode:r,codeVerifier:e.codeVerifier,redirectUri:e.redirectUri};return E(t),s.getAccessToken(o.tokenUrl,{client_id:t.clientId,redirect_uri:t.redirectUri,grant_type:"authorization_code",code:t.authorizationCode,code_verifier:t.codeVerifier}).then(function(e){return p(e,t),e})}).fin(function(){d.clearPKCEMeta()})}(i,t.code,a);throw new Error("authroize message does not have code")}).then(function(e){var t={};if(e.access_token&&(t.access_token={accessToken:e.access_token,expiresAt:Number(e.expires_in)+Math.floor(Date.now()/1e3),tokenType:e.token_type,scopes:u,authorizeUrl:a.authorizeUrl,userinfoUrl:a.userinfoUrl}),e.id_token){var n=O(e.id_token),r={idToken:e.id_token,claims:n.payload,expiresAt:n.payload.exp,scopes:u,authorizeUrl:a.authorizeUrl,issuer:a.issuer,clientId:c},o={clientId:c,issuer:a.issuer,nonce:i.nonce};return i.ignoreSignature!==undefined&&(o.ignoreSignature=i.ignoreSignature),M(r,o).then(function(){return t.id_token=r,t})}return t}).then(function(t){return r(n,function(e){if(!t[e])throw new Error("Unable to parse OAuth flow response: "+e+" was not returned.")}),d.setAuthTokenByDomain(e.oktaDomain,t).then(function(){return Log.debug("sucessfully got token for domain {0}",e.oktaDomain),t})})}function z(e,u){return u=u||{},A(c,e=e||{}).then(function(t){var e,n;n=v(c);var r=m(t);e=n.authorizeUrl+"?"+g(r);var o=L(c,u.timeout,t.state),i=function a(e){var t=document.createElement("iframe");return t.style.display="none",t.src=e,document.body.appendChild(t)}(e);return o.then(function(e){return P(c,t,e,n)}).fin(function(e){return document.body.contains(i)&&i.parentElement.removeChild(i),e})})}return I.token={},I.token.getWithoutPrompt=function(e,t){if(!c.url)throw new Error("missing url in sdkOptions");return z(e,t)},I};