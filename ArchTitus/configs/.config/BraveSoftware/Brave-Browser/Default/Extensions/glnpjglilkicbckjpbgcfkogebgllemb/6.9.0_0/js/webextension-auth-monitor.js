Okta.AuthenticationMonitor=function(r,i){var e=Okta.Q;var t=Okta._okta;var o=t.delay;var a=t.each;var n=t.find;var u=t.last;var s=Okta.fn.url.getOktaFederatedRequestMatchPatterns;var d=Okta.fn.url.isAllowedOktaRequestForAuthMonitoring;var l=false;var f=false;var c=false;var m={};var h=20;var g=2e4;var v={};function b(e){return v[e]}function p(e,t){v[e]=t}function R(e){delete v[e]}function q(e,t){if(!t||!e){return}t.push({url:e.url,startTimeStamp:e.timeStamp});p(e.tabId,t)}function L(e,t){var r=u(t);r.method=e.method;r.statusCode=e.statusCode;r.endTimeStamp=e.timeStamp;r.responseTimeMs=Math.round(r.endTimeStamp-r.startTimeStamp);r.error=e.error;p(e.tabId,t)}function w(n){return e.all([r.getOktaDomain(),r.getVersion(),r.getSessionCookie()]).spread(function(e,t,r){if(!e){Log.warn("Failed to find Okta domain from persistent storage. Not "+"logging interaction");return}if(!t){Log.warn("Failed to find plugin version from persistent storage. Not "+"logging interaction");return}if(!r||!r.sid||!r.DT){Log.warn("Failed to find a valid Okta session. Not logging interaction");return}i.ajax({url:e+"/api/plugin/2/log?plugin_version="+t.backgroundVersion+"-"+t.contentVersion,type:"POST",beforeSend:function(e){e.setRequestHeader("Accept","application/json;charset=utf-8");e.setRequestHeader("Plugin-Sid",r.sid);e.setRequestHeader("X-Session-Id",r.sid);e.setRequestHeader("X-Device-Token",r.DT)},data:{message:n,logLevel:"INFO"}})})}function S(t){return r.getOktaDomain().then(function(e){if(!e){return false}if(!t||!t.url||t.url.indexOf(e)!==0){return false}if(!d(t.url)){return false}return true})}function O(e,t,r){var n="Auth Interaction: ";a(e,function(e,t){e.startTimeStamp=undefined;e.endTimeStamp=undefined;e.url=t===0||c?encodeURI(e.url):undefined});n+=JSON.stringify(e);R(t);if(!r||f){return w(n)}}function T(e){if(!e||!e.transitionQualifiers){return false}if(e.transitionType==="link"&&e.transitionQualifiers.length>0&&e.transitionQualifiers[0]==="server_redirect"){return false}return e.transitionType==="auto_subframe"||!!n(e.transitionQualifiers,function(e){return e==="client_redirect"||e==="server_redirect"})}function k(e){if(!e||!e.transitionQualifiers){return false}return e.transitionType==="typed"||e.transitionType==="auto_bookmark"||e.transitionType==="reload"}function I(){if(!chrome.webRequest.onSendHeaders||!chrome.webRequest.onCompleted||!chrome.webRequest.onBeforeRedirect||!chrome.webRequest.onErrorOccurred||!chrome.webNavigation.onCommitted||!chrome.tabs.onRemoved){Log.warn("AuthenticationMonitor::isSupported: Current version of "+"the browser does not support this functionality");return false}return true}function y(t){return S(t).then(function(e){e&&q(t,[])})}function C(r){return S(r).then(function(e){if(!e){return}var t=b(r.tabId);if(!t||t.length===0){return}L(r,t);if(r.statusCode>=400||r.error){O(t,r.tabId,false);return}})}function _(e){var t=b(e.tabId);if(!t||t.length===0){return}if(t.length===1&&t[0].url===e.url){return}q(e,t)}function A(t){var e=b(t.tabId);if(!e||e.length===0){return}var r=e.length;if(r===1&&e[0].url===t.url){return}if(r===2&&t.method!=="POST"){R(t.tabId);return}var n=u(e);if(n.url!==t.url){q({timeStamp:n.endTimeStamp,url:t.url},e);n=u(e);r++}if(r===h){n.oktaError="request queue reached maximum capacity of "+h+" web requests"}L(t,e);if(t.statusCode>=400||t.error||r===h){return O(e,t.tabId,false)}if((t.method==="GET"||t.method==="POST")&&t.statusCode<300){o(function(){var e=b(t.tabId);if(!e){return}if(e.length>r){return}O(e,t.tabId,true)},g)}}function H(e){var t=b(e.tabId);if(!t||t.length<=2){return}if(k(e)){R(e.tabId);return}if(!T(e)){t.pop();return O(t,e.tabId,true)}}function M(e){R(e)}function E(){if(!l){Log.info("AuthenticationMonitor::removeRequestListeners: "+"no listeners are attached to be removed");return}chrome.webRequest.onSendHeaders.removeListener(y);chrome.webRequest.onCompleted.removeListener(C);chrome.webRequest.onErrorOccurred.removeListener(C);chrome.webRequest.onSendHeaders.removeListener(_);chrome.webRequest.onBeforeRedirect.removeListener(A);chrome.webRequest.onCompleted.removeListener(A);chrome.webRequest.onErrorOccurred.removeListener(A);chrome.webNavigation.onCommitted.removeListener(H);chrome.tabs.onRemoved.removeListener(M);l=false;Log.info("AuthenticationMonitor::removeRequestListeners: "+"removed all listeners")}function F(){if(l){Log.info("AuthenticationMonitor::addRequestListeners: "+"listeners already attached");return}var e=s();chrome.webRequest.onSendHeaders.addListener(y,{urls:e},["requestHeaders"]);chrome.webRequest.onCompleted.addListener(C,{urls:e});chrome.webRequest.onErrorOccurred.addListener(C,{urls:e});chrome.webRequest.onSendHeaders.addListener(_,{urls:["<all_urls>"],types:["main_frame"]},["requestHeaders"]);chrome.webRequest.onBeforeRedirect.addListener(A,{urls:["<all_urls>"],types:["main_frame"]});chrome.webRequest.onCompleted.addListener(A,{urls:["<all_urls>"],types:["main_frame"]});chrome.webRequest.onErrorOccurred.addListener(A,{urls:["<all_urls>"],types:["main_frame"]});chrome.webNavigation.onCommitted.addListener(H);chrome.tabs.onRemoved.addListener(M);l=true;Log.info("AuthenticationMonitor::addRequestListeners: "+"added all listeners")}m.initialize=function(e){f=!!e;if(!I()){return}return r.getPluginSettings().then(function(e){if(e&&e.orgSettings&&e.orgSettings.pluginAuthFailureDetectionEnabled){F();c=e.orgSettings.pluginAuthFailureDetectionShowUrlEnabled;return}Log.info("AuthenticationMonitor::initialize: Auth monitoring feature "+"is disabled");E();return})};return m};